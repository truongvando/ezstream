# SRS Configuration for EZStream
# Optimized for BunnyCDN â†’ YouTube streaming

# Global settings
listen              1935;
max_connections     1000;
srs_log_tank        file;
srs_log_file        ./objs/srs.log;
srs_log_level       info;

# HTTP API for management
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# HTTP Server for stats and management
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

# Stats configuration
stats {
    network         0;
    disk            sda sdb xvda xvdb;
}

# Default vhost for YouTube streaming
vhost __defaultVhost__ {
    # Enable HTTP-FLV for monitoring
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
    
    # Enable HLS for monitoring
    hls {
        enabled         on;
        hls_fragment    10;
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    # DVR for debugging (optional)
    dvr {
        enabled         off;
        dvr_path        ./objs/nginx/html/[app]/[stream].[timestamp].flv;
        dvr_plan        session;
        dvr_duration    30;
        dvr_wait_keyframe   on;
    }
    
    # Security settings
    security {
        enabled         off;
        seo {
            enabled     off;
        }
    }
}

# YouTube streaming vhost
vhost youtube.com {
    # Ingest configuration will be added dynamically via API
    # Example ingest (managed by Python agent):
    #
    # ingest livestream {
    #     enabled      on;
    #     input {
    #         type     stream;
    #         url      https://cdn.bunny.net/video.mp4;
    #     }
    #     ffmpeg       /usr/local/bin/ffmpeg;
    #     engine {
    #         enabled  off;  # Copy mode for performance
    #         output   rtmp://a.rtmp.youtube.com/live2/STREAM_KEY;
    #     }
    # }
    
    # HTTP-FLV for monitoring
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
    
    # HLS for monitoring
    hls {
        enabled         on;
        hls_fragment    10;
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    # Transcode settings (if needed)
    transcode {
        enabled     off;
        ffmpeg      /usr/local/bin/ffmpeg;
        
        # YouTube FHD profile
        engine youtube_fhd {
            enabled         off;
            vfilter {
                # Scale to 1920x1080 if needed
                v               scale=1920:1080;
            }
            vcodec          libx264;
            vbitrate        5000;
            vfps            30;
            vwidth          1920;
            vheight         1080;
            vthreads        4;
            vprofile        high;
            vpreset         fast;
            vparams {
                # YouTube optimized settings
                tune            zerolatency;
                level           4.0;
                maxrate         6000k;
                bufsize         12000k;
                g               60;  # GOP size (2s at 30fps)
            }
            acodec          aac;
            abitrate        128;
            asample_rate    44100;
            achannels       2;
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_[engine];
        }
    }
    
    # Forward to multiple destinations (if needed)
    forward {
        enabled     off;
        destination {
            enabled     off;
            url         rtmp://a.rtmp.youtube.com/live2/STREAM_KEY;
        }
    }
    
    # Security
    security {
        enabled         off;
        seo {
            enabled     off;
        }
    }
}

# Multi-platform streaming vhost (for future use)
vhost multistream.com {
    # Forward to multiple platforms
    forward {
        enabled     off;
        destination {
            enabled     off;
            url         rtmp://a.rtmp.youtube.com/live2/YOUTUBE_KEY;
        }
        destination {
            enabled     off;
            url         rtmp://live.twitch.tv/app/TWITCH_KEY;
        }
        destination {
            enabled     off;
            url         rtmp://ingest.facebook.com/rtmp/FACEBOOK_KEY;
        }
    }
    
    # HTTP-FLV for monitoring
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
    
    # HLS for monitoring
    hls {
        enabled         on;
        hls_fragment    10;
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
}

# Heartbeat for monitoring
heartbeat {
    enabled         on;
    interval        30;
    url             http://127.0.0.1:1985/api/v1/summaries;
    device_id       "ezstream-srs-server";
    summaries       on;
}

# Cluster settings (for future scaling)
cluster {
    mode            local;
    origin_cluster  off;
    token_traverse  off;
    vhost           __defaultVhost__;
}

# Performance tuning
# Increase buffer sizes for better performance
mr {
    enabled         off;
    latency         350;
}

# Reduce latency settings
rtc_server {
    enabled         off;
    listen          8000;
    candidate       $CANDIDATE;
}

# GB28181 (disabled for now)
sip {
    enabled         off;
}

# WebRTC (disabled for now)
rtc {
    enabled         off;
}

# SRT (disabled for now)
srt_server {
    enabled         off;
}
